name: Inner Build - Windows x64

on:
  workflow_dispatch:     # manual trigger
  push:
    branches:
      - main
permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.9'
          cache: true

      - name: Enable Windows Desktop
        run: flutter config --enable-windows-desktop

      - name: Get Dependencies
        run: flutter pub get

      - name: Read Version from pubspec.yaml
        id: version
        run: |
          $version = (Select-String -Path pubspec.yaml -Pattern "^version: (.+)" | ForEach-Object { $_.Matches[0].Groups[1].Value })
          echo "VERSION=$version" >> $env:GITHUB_ENV

      - name: Build Windows x64 Release
        run: flutter build windows --release

      - name: Zip Release
        run: |
          $releaseDir = Join-Path $env:GITHUB_WORKSPACE "release"
          New-Item -ItemType Directory -Path $releaseDir -Force | Out-Null
          $zipPath = Join-Path $releaseDir "nexxpharma-$env:VERSION.zip"
          Compress-Archive -Path "build/windows/x64/runner/Release/*" -DestinationPath $zipPath

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: nexxpharma-windows-release
          path: release/nexxpharma-${{ env.VERSION }}.zip
          if-no-files-found: error

      - name: Create or Update GitHub Release
        uses: ncipollo/release-action@v1
        with:
          tag: v${{ env.VERSION }}
          name: nexxpharma v${{ env.VERSION }}
          artifacts: release/nexxpharma-${{ env.VERSION }}.zip
          draft: false
          prerelease: false
          allowUpdates: true
          replacesArtifacts: true
          token: ${{ secrets.GITHUB_TOKEN }}
