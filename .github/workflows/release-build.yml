name: Release Build - Installer

on:
  workflow_run:
    workflows: ["Inner Build - Windows x64"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch:
    inputs:
      version:
        description: 'Version for release (e.g., v1.0.0)'
        required: false

permissions:
  contents: write  # Needed for creating releases

jobs:
  build-installer:
    runs-on: windows-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Download Inner Build artifact
      - name: Download Inner Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: nexxpharma-windows-release
          path: build/windows-x64-for-installer
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id || github.run_id }}

      # Prepare Installer Folder with organized structure
      - name: Prepare Installer Folder
        run: |
          if (-not (Test-Path "build\windows-x64-for-installer")) {
            Write-Error "Error: Inner build artifact not found"
            exit 1
          }
          if (Test-Path "installer\Release") { Remove-Item "installer\Release" -Recurse -Force }
          New-Item -ItemType Directory -Path "installer\Release" -Force | Out-Null
          
          # Extract zip file from inner build
          $sourceZip = Get-ChildItem "build\windows-x64-for-installer\*.zip" -ErrorAction SilentlyContinue
          if (-not $sourceZip) {
            Write-Error "Error: No zip file found in build\windows-x64-for-installer"
            exit 1
          }
          
          Write-Host "Extracting: $($sourceZip.FullName)"
          Expand-Archive -Path $sourceZip.FullName -DestinationPath "installer\Release\temp" -Force
          $sourceDir = "installer\Release\temp"
          
          # Copy all extracted files into Release
          Copy-Item -Path (Join-Path $sourceDir '*') -Destination "installer\Release" -Recurse -Force
          
          # Cleanup temp folder
          Remove-Item "installer\Release\temp" -Recurse -Force -ErrorAction SilentlyContinue
          
          Write-Host "Installer preparation complete. Contents:"
          Get-ChildItem -Path "installer\Release" -Recurse | ForEach-Object { Write-Host $_.FullName }

      # Install Inno Setup
      - name: Install Inno Setup
        run: choco install innosetup -y

      # Get Version
      - name: Get Version
        id: version
        run: |
          if ("${{ github.event.inputs.version }}" -ne "") {
            echo "version=${{ github.event.inputs.version }}" >> $env:GITHUB_OUTPUT
          } else {
            $version = Select-String -Path "pubspec.yaml" -Pattern "version: ([0-9.]+)" | ForEach-Object { $_.Matches[0].Groups[1].Value }
            echo "version=$version" >> $env:GITHUB_OUTPUT
          }

      # Create output directory
      - name: Create Output Directory
        run: |
          if (Test-Path "installer\output") { Remove-Item "installer\output" -Recurse -Force }
          New-Item -ItemType Directory -Path "installer\output" -Force | Out-Null

      # Build Installer using .iss script
      - name: Build Installer
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" "/Oinstaller\output" "/DAPPVERSION=${{ steps.version.outputs.version }}" "${{ github.workspace }}\installer\installer.iss"

      # Upload installer artifact temporarily (optional)
      - name: Upload Installer Artifact
        uses: actions/upload-artifact@v4
        with:
          name: nexxpharma-installer
          path: installer/output/*.exe
          if-no-files-found: error

      # Create GitHub Release (permanent URL)
      - name: Publish Installer to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: nexxpharma v${{ steps.version.outputs.version }}
          files: installer/output/*.exe
          overwrite_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}